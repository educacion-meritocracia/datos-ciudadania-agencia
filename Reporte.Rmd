---
title: "Reporte Base de datos Agencia de la Educación"
author: "Juan Carlos Castillo, Daniel Miranda & José Conejeros"
date: '`r format(Sys.time(), "%d/%m/%Y")`'
output:
  rmdformats::readthedown:
    css: color.css
    highlight: tango
    code_folding: hide
    self_contained: true
    thumbnails: false
    lightbox: false
subtitle: "Fondecyt 1181239. Socialización política y educación para la ciudadanía: el rol de la familia y de la escuela."
---

<div style="text-align: justify"> 

A continuación se expone el reporte técnico con el análisis de las bases de datos otorgadas por la Agencia de la Calidad de la Educación, en marco de su evaluación nacional sobre formación ciudadana realizada el año 2017 a una muestra representativa de estudiantes de 8º básico. Esta evaluación cuenta con una muestra de escuelas llegando a un total de **10.213** estudiantes de 8º básico y considera la aplicación de cuestionarios actitudinales para los/as estudiantes y sus padres. 

En ese sentido, el **objetivo** de este reporte es profundizar en un aspecto central del proyecto Fondecyt: identificar la transmisión intergeneracionla de la desigualdad política, orientada a evaluar la coincidencia de las actitudes, conocimiento, creencias y comportamiento para el ejercicio de la ciudadanía entre padres/madres y sus hijos(as). Para esto, el presente reporte considera el análisis de tres instrumentos: 

+ Resultados prueba de conocimiento cívico `bbdd_puntajes`
+ Cuestionarios a estudiantes sobre creencias, conocimiento, actitudes y prácticas (CCAP), para el ejercicio de la ciudadanía:`bbdd_estudiantes`
+ Cuestionarios a estudiantes sobre creencias, conocimiento, actitudes y prácticas (CCAP), para el ejercicio de la ciudadanía:`bbdd_padres`

Este documento se divide en cuatro secciones: análisis de calidad de las bases de datos, variables disponibles para el estudio, descripción de las principales variables relevantes para los objetivos del proyecto y análisis correlacional de las principales variables entre padres e hijos, para finalizar con una sección de análisis de regresión múltiple considerando la información disponible.

</div>

```{r opciones globales, warning=FALSE, cache=FALSE, include=FALSE, results="asis", echo=TRUE}
rm(list = ls()) #limpiar la memoria
#Desactivar notación científica
options(scipen=999)
#Paquetes
library(knitr)
library(rmdformats)
library(DT)
library(dplyr)
library(haven)
library(texreg) 
library(xtable) 
library(kableExtra) 
library(ggplot2)
library(shiny)
library(psych)
library(PerformanceAnalytics)
library(purrr)
library(tidyr)
library(vcd)
library(vcdExtra)
library(skimr)
library(sjmisc)
library(dplyr)
library(stargazer)

#Global
options(max.print = "500")
opts_chunk$set(echo = FALSE,
	             cache = FALSE,
               prompt = FALSE,       
               tidy = FALSE,
               comment = NA,
               message = FALSE,
               warning = FALSE)
opts_knit$set(width = 500)
options(max.print=1000000)
```

# Calidad bases de datos

## Información disponible

<div style="text-align: justify"> 

La información facilitada por la agencia de la educación se puede desglosar en tres bases de datos que tienen observación para los estudiantes de la muestra y sus padres. A continuación se detallan el número de observaciones y variables respectivas.

</div> 

```{r bbdd, echo=TRUE, eval=TRUE}
#Abrir bases de datos
bbdd_puntajes <- read_dta("bbdd/alumnosFc_mrun.dta")
bbdd_alumnos <- read_dta("bbdd/cuestAlumnos.dta")
bbdd_padres <- read_dta("bbdd/cuestPadres.dta")
#Transformamos nuestras bases a un data frame
bbdd_puntajes <- as.data.frame(bbdd_puntajes)
names(bbdd_puntajes) <- tolower(names(bbdd_puntajes)) 
bbdd_alumnos <- as.data.frame(bbdd_alumnos)
names(bbdd_alumnos) <- tolower(names(bbdd_alumnos)) 
bbdd_padres <- as.data.frame(bbdd_padres)
names(bbdd_padres) <- tolower(names(bbdd_padres)) 
#Tabla con las observaciones y variables para cada base de datos
puntajes <- dim(bbdd_puntajes)
alumnos <- dim(bbdd_alumnos)
padres <- dim(bbdd_padres)
names <- c("Puntajes", "Cuestionario Alumnos", "Cuestionario Padres")
data <- rbind(puntajes, alumnos, padres)
data <- as.data.frame(cbind(names, data))
colnames(data) <- c("Base de datos", "Observaciones", "Variables")
datatable(data, rownames=FALSE, filter="none", options=list(pageLength=10, scro11X=TRUE), style="default", class="compact")
```

<div style="text-align: justify"> 

Se realiza un merge con las tres bases de datos anteriores consolidando todo en una base única (`bbdd`). A raíz de las diferencias entre las observaciones disponibles detalladas en la tabla anterior, se obtiene un número importante de casos pérdidos para la base final. 

A pesar de que la unión de estas tres bases de datos arroja una base general `bbdd` con **10.213** observaciones, se debe considerar que hay **3.443** casos para los que no tenemos información completa disponible en  alguna de las tres bases de datos anteriores. A partir A continuación se realiza una aproximación exploratoria para las variables existentes en cada una de las tres bases de datos. En la siguiente sección se realizará un análisis más detallado de estos casos pérdidos. 

</div> 

## Exploración bases de datos

<div style="text-align: justify"> 

El principal inconveniente de estas bases de datos es que las categorías 99 (doble marca) y 0 (vacío) no están registrados como casos pérdidos, por ende perdemos aún más observaciones sobre todo en el cuestionario de padres. Se debe tener claro esto a la hora de realizar los análisis en pro de las hipótesis del proyecto. 

</div> 

### BBDD Puntajes

+ Base de datos con la información sobre los puntajes obtenidos en la prueba de conocimiento cívico.  

```{r puntajes, echo=TRUE, eval=TRUE}
#Despejamos el environment
rm(puntajes, alumnos, padres, names, data)
#Base General con los puntajes: recodificamos el sexo a un factor
bbdd_puntajes$sexo <- rec(bbdd_puntajes$sexo, rec="M=1; F=0")
bbdd_puntajes$sexo <-factor(bbdd_puntajes$sexo, levels = c(0,1), labels = c("Mujer", "Hombre"))
#Exploramos la base de datos
skim_with(numeric = list(complete=NULL, p25=NULL, p50=NULL, p75=NULL),factor = list(complete=NULL), integer = list(complete=NULL), character = list(complete=NULL))
skim(bbdd_puntajes, idalumno, mrbd, codigocurso, numerolista, sexo, ponderador, puntaje) %>% pander() #1841 missing
```

### BBDD Alumnos

+ Base de datos con las respuestas del cuestionario sobre CCAP para el ejercicio de la ciudadanía en estudiantes. Las categorías de 0 (vacío) y 99 (doble marca) se recodifican como missing.

```{r alumnos, echo=TRUE, eval=TRUE}
#Base General con el cuestionario para estudiantes
#Codificamos los valores 99 como missing para todas las variables con rango [1-4]
bbdd_alumnos <- bbdd_alumnos %>%
    mutate_at(vars(4:222), na_if, 99) %>%
    mutate_at(vars(4:222), na_if, 0)
bbdd_alumnos <- bbdd_alumnos %>%
    mutate_at(vars(22), na_if, 99) %>%
    mutate_at(vars(4:222), na_if, 0)
#Exploramos la base de datos
skim_with(numeric = list(complete=NULL, p25=NULL, p50=NULL, p75=NULL),factor = list(complete=NULL), integer = list(complete=NULL), character = list(complete=NULL))
skim(bbdd_alumnos) %>% pander() 
```

### BBDD Padres

+ Base de datos con las respuestas del cuestionario sobre CCAP para el ejercicio de la ciudadanía en estudiantes. Las categorías de 0 (vacío) y 99 (doble marca) se recodifican como missing. Se debe tener precaución con el mes y año de nacimiento del padre/madre pues presentan inconsistencia en los datos, además no hay una variable disponible que de cuenta de la edad del padre/madres. 


```{r padres, echo=TRUE, eval=TRUE}
#Base General con el cuestionario para padres
#Codificamos los valores 99 como missing para todas las variables con rango [1-4]
bbdd_padres <- bbdd_padres %>%
    mutate_at(vars(4:141), na_if, 99) %>%
    mutate_at(vars(4:141), na_if, 0)
#Exploramos la base de datos
skim_with(numeric = list(complete=NULL, p25=NULL, p50=NULL, p75=NULL),factor = list(complete=NULL), integer = list(complete=NULL), character = list(complete=NULL))
skim(bbdd_padres) %>% pander()
```

## Análisis de no respuesta

<div style="text-align: justify"> 

Dadas las diferencias observadas en el merge entre las tres bases de datos se procede a realizar un análisis que tiene por objetivo dimensionar la no respuesta a los cuestionarios completos y a la prueba de conocimiento. Dada la codificación presentada en el apartado anterior se debe tener claro la existencia de missing (valores 0 y 99) para variables en particular, lo cual será revisado en detalle para las variables de interés del estudio. A continuación se presenta el análisis general de la no respuesta. 


### Bases de datos independientes

```{r nr, echo=TRUE, eval=TRUE}
#Cantidad de no respuesta prueba de conocimiento
sum(is.na(bbdd_puntajes$puntaje))
#Cantidad de no respuesta en el cuestionario de alumnos
sum(!complete.cases(bbdd_alumnos))
#Cantidad de no respuesta en el cuestionario de padres 
sum(!complete.cases(bbdd_padres))
```

+ La no respuesta para la base `bbdd_puntajes` corresponde a **1841 observaciones**, para las cuales no hay información en los resultados de la prueba de conocimiento.

+ Para la base de datos `bbdd_alumnos` no se observa una falta de respuesta completa a los cuestionarios, sin embargo, todas las variables de este estudio presentan niveles de no respuesta a considerar. Dicho esto, se debe tener en cuenta que esta base de datos solo cuenta con una muestra de 8589 observaciones para los análisis.

+ Para el cuestionario de padres `bbdd_padres` se observa que una importante conjunto de casos perdidos estan en la pregunta referida al nivel educacional alcanzado por el respondente y su cónyuge/pareja ([BBDD Padres]). Se especula que esto se produce a raíz de la codificación de la pregunta, en que las personas indican solo una opción de nivel educacional aunque no hay información respectiva que ayude a identificar cada pregunta. Revisar con detalle esta pregunta pues es relevante su utilización.

### Merge de las bases de datos

```{r nr2, echo=TRUE, eval=TRUE}
#Identificamos respuestas en ambos cuestionarios
bbdd_alumnos$resp_al <- 1
bbdd_padres$resp_pap <- 1

#Merge con la base de alumnos
bbdd_missing1 <- merge(bbdd_puntajes, bbdd_alumnos, by="idalumno", all=T, suffixes = c("",".y"))
#Identificamos missing
bbdd_missing1$resp_al[is.na(bbdd_missing1$puntaje) & bbdd_missing1$resp_al == 1] <- 0
#Exploramos
skim_with(numeric = list(complete=NULL, p25=NULL, p50=NULL, p75=NULL),factor = list(complete=NULL), integer = list(complete=NULL), character = list(complete=NULL))
skim(as.factor(bbdd_missing1$resp_al)) %>% pander()
#Dado del nivel de missing de la base original se obtiene la diferencia
(1624 + 245)-1841 #Hay 28 observaciones más con los resultados en la prueba de conocimiento.

#Generamos una base de datos solo con la información disponible
bbdd1<- merge(bbdd_puntajes, bbdd_alumnos, by="idalumno", all=F, suffixes = c("",".y"))
bbdd1$resp_al[is.na(bbdd1$puntaje) & bbdd1$resp_al == 1] <- 0
bbdd1 <- bbdd1[!bbdd1$resp_al == "0", ] 

#Realizamos el mismo ejercicio para identificar los missing con el cuestionario de padres a partir de la última base de datos generada
bbdd_missing2 <- merge(bbdd1, bbdd_padres, by="idalumno", all=T, suffixes = c("",".y"))
#Identificamos missing
bbdd_missing2$resp_pap[is.na(bbdd_missing2$resp_al) & bbdd_missing2$resp_pap == 1] <- 0
skim(as.factor(bbdd_missing2$resp_pap)) %>% pander()
```

Al realizar el merge respectivo entre las bases `bbdd_puntajes` y `bbdd_alumnos` se observa la **pérdida de información de 1624 observaciones para los/as cuales no tenemos datos sobre la prueba de conocimiento** ni de los cuestionarios, esto se genera por defecto a la hora de unir las bases. A su vez, se observa **245 casos que aparecen con información solo en el cuestionario para estudiantes, pero no tienen un puntaje en la prueba de conocimiento**, está perdida es relevante, pues considera las variables de análisis. Por último, se estima **28 observaciones adicionales que solo tienen información en la prueba de conocimiento**. En definitiva, se pierden 1869 observaciones de las cuales 1841 corresponden por no tener información en la base de datos de puntaje y 28 por no tener información en los cuestionarios. 

El merge de ambas bases de datos nos deja un **saldo de 8344 casos** en los que efectivamente hay información de datos con los puntajes obtenidos en la prueba de conocimiento y el cuestionario respectivo (se mantienen una base de datos solo con estos casos).

Mismo ejercicio para incorporar la base de datos `bbdd_padres`. Aquí observamos la **pérdida de 2002 casos en las que no hay información disponible para el cuestionario de padres**. Nuevamente, esta información perdida se da por defecto al unir ambas bases de datos. A su vez, hay otros **428 casos para los cuales si tenemos información en el cuestionario de padres, pero no para el cuestionario de alumnos ni resultados en la prueba de conocimiento**. En definitiva, la unión de las tres bases nos dejan un **resultado de 6342 observaciones con información disponible en los tres insumos**, lo que será la base de trabajo. Por el momento solo se etiquetan las variables utilizadas en la sección de [Variables Espejo: vínculo entre padres e hijos]

Finalmente, en un intento por dimensionar la no respuesta se realizan regresiones binomiales sobre no responder/responder el cuestionario con variables sociodemográficas disponibles. Lamentablemente, esto se realiza con la información disponible por lo que no hay como identificar otros antecedentes cuando no hay datos para ninguna de las bases tal como se detallo previamente. Los resultados muestran que el aumento de libros en el hogar aumenta las chances de responder el cuestionario en 1.39 veces más controlando por el sexo de los estudiantes y religión. Por otra parte, ser hombre disminuye las chances de responder el cuestionario en 0.75 veces respecto de ser mujer controlando por las otras variables. Esto podría caracterizar la no respuesta, aunque no hay suficiente información disponible para realizar un ejercicio más completo.  

En la siguiente sección revisaremos las variables disponibles para proceder a su análisis descriptivo. Para este ejercicio se utilizara una base de datos consolidada con información para las tres bases de datos. En ese sentido, se asume un costo de representatividad de la muestra dada la pérdida de casos.

```{r reg, echo=TRUE, eval=TRUE, results = "asis"}
#Intento por dimensionar la no 
#Base de datos alumnos
nresp <- subset(bbdd_missing1, select = c(resp_al, sexo, alp2, alp3))
nresp <- nresp[complete.cases(nresp$resp_al),]
nresp <- glm(as.factor(resp_al)~sexo+alp2+alp3, data=nresp, family="binomial")
#Tabla
stargazer(nresp, title = "No respuesta cuestionario alumnos",
           covariate.labels=c("Sexo estudiante", "Religión", "Libros en el hogar"),
          column.labels=c("Modelo Alumnos"), type ='html', font.size = "small", align = TRUE, omit.stat=c("f", "ser"), column.sep.width = "-15pt")
exp(0.327)
exp(-0.289)
```

</div> 

# Variables Disponibles

<div style="text-align: justify"> 

La siguiente sección tiene por objetivo presentar las variables analizadas por el estudio de la Agencia de la Calidad de la Educación. Dado de que no se dispone de los cuestionarios ni un libro de códigos directos, se procede a presentar las preguntas y variables con la información disponible. Finalmente se expone las principales variables que puedan ser relevantes para el proyecto de investigación. 

## Preguntas de los cuestionarios

A continuación se presentan un desgloce de todas las preguntas de los cuestionarios enfocado a identificar si se encuentra disponible en la base de datos para alumnos y padres, categorizarla según temática de estudio, descripción de la pregunta y principales atributos. Dada ciertas inconsistencias observadas en la base de datos se detallan observaciones para ciertas variables problemáticas. 

</div> 

```{r base variables, echo=TRUE, eval=TRUE}
#Despejamos el environment
rm(bbdd_missing1, bbdd1, bbdd_missing2, nresp, nrespap)
#Tabla con las variables del estudio
variables <- data.frame(read_dta("bbdd/variables_alumnos.dta"))
#Base de datos 
variables <- variables %>% dplyr::select(identificador_ambos, bbdd_alumnos, bbdd_padres, categoria, descripcion, atributos, observacion)
colnames(variables) <- c("Identificador", "BBDD Alumnos", "DBBDD Padres", "Temática", "Descripción", "Atributos", "Observación")
variables <- variables[order(variables$Temática),]
datatable(variables, rownames=FALSE, filter="top", options=list(pageLength=10, scro11X=TRUE), style="default", class="compact")
```

## Temáticas del estudio

<div style="text-align: justify"> 

A continuación se presentan todas las temáticas presentes en los cuestionarios de alumnos y sus padres. Es importante mencionar que el identificador nos permite observar si es que dicha temática se encuentra disponible en ambas bases de datos o solo en una. 

</div> 

```{r base temas, echo=TRUE, eval=TRUE}
#BBDD con los temas de los cuestionarios
temas <- data.frame(read_dta("bbdd/temas.dta"))
colnames(temas) <- c("Identificador", "Temática", "Observación")
temas <- temas[order(temas$Temática),]
datatable(temas, rownames=FALSE, filter="top", options=list(pageLength=20, scro11X=TRUE), style="default", class="compact")
```

## Temás relevantes para el proyecto

<div style="text-align: justify"> 

A partir de las variables con información disponible en ambos cuestionarios: estudiantes y padres se considerarn como relevantes los siguientes temas de investigación para el proyecto: *interés político*, *percepción sobre la democracia*. *participación política*, *participación en organizaciones*, *atributos de un buen ciudadano*, *confianza en las instituciones* y *percepciones sobre paz y violencia*. La tabla a continuación detalla las preguntas específicas y sus atributos referidos a estos temas.  

```{r temas proyecto, echo=TRUE, eval=TRUE}
#Tabla con las temáticas relevantes para el proyecto
proyecto <- subset(variables, select = c(1,4,5,6))
#Filtramos por las temáticas de interés 
proyecto <- proyecto %>%
  filter(Identificador=="Alumno y Padres" & Temática=="Interés Político" |  Temática=="Percepciones sobre la democracia" | Temática=="Participación Política" | Temática=="Participación en organizaciones"  | Temática=="Buen Ciudadano" |  Temática=="Confianza en las instituciones"   | Temática=="Percepciones sobre paz y violencia")
#Tabla
proyecto <- subset(proyecto, select = c(2:4))
datatable(proyecto, rownames=FALSE, filter="top", options=list(pageLength=20, scro11X=TRUE), style="default", class="compact")
```
 
Otras temáticas interesantes de observar y que no están consideradas en este listado y análisis son las siguientes: actitudes hacia inmigrantes y grupos étnicos, actitudes hacia la equidad de género, percepciones sobre la igualdad de oportunidades y preferencias por desigualdad. En términos de variables sociodemográficas se consideran variables relevantes para los estudiantes y sus padres. Se observan inconsistencias en las siguientes variables: 

+ Fecha de Nacimiento (Mes) padres: variable presenta varios valores atípicos dentro de la muestra final (239 casos con valor 999).
+ Fecha de Nacimiento (año) padres: variable presenta varios valores atípicos dentro de la muestra final (146 casos con años de nacimiento inferiores a 1900 y 125 casos con años de nacimiento superiores a los 1995).
+ Edad padres: variable no disponible en la base de datos con el cuestionario para padres.
+ Trabajo principal de los padres: Variable codificada con 0 y 1, no hay más información.
+ Nivel educacional de los padres: Variable con dos valores que identifica si el respondente o el cónyuge tiene un nivel educativo específico. Son 10 niveles educacionales (revisar una potencial recodificación).

```{r sociodemograficas, echo=TRUE, eval=TRUE}
#Tabla con las temáticas relevantes para el proyecto
sociod <- subset(variables, select = c(1,4,5,6))
#Filtramos por las temáticas de interés 
sociod <- sociod %>%
  filter(Identificador=="Padres" | Identificador=="Alumno y Padres" & Temática=="Sociodemográficos") %>%
  filter(Temática=="Sociodemográficos")
#Tabla
sociod <- subset(sociod, select = c(2:4))
datatable(sociod, rownames=FALSE, filter="top", options=list(pageLength=30, scro11X=TRUE), style="default", class="compact")
```

</div> 

# Variables Espejo: vínculo entre padres e hijos

A continuación se presenta la codificación y análisis descriptivo / correlacional exploratorio con las principales variables de estudio que se replican integramente en los cuestionarios para padres e hijos. Cabe mencionar que el análisis considera una base de datos con 6243 observaciones correspondiente a los datos disponibles, aunque es posible observar mayor cantidad de missing dada la respuesta en blanco de algunas variables. 

```{r merge, echo=TRUE, eval=TRUE, results = "asis"}
#Despejamos el environment
rm(proyecto, sociod, temas, variables)
#Generamos una base de datos solo con la información disponible: 6342 observaciones
bbdd<- merge(bbdd_puntajes, bbdd_alumnos, by="idalumno", all=F, suffixes = c("",".y"))
bbdd$resp_al[is.na(bbdd$puntaje) & bbdd$resp_al == 1] <- 0
bbdd <- bbdd[!bbdd$resp_al == "0", ] 
#Agregamos la segunda base
bbdd <- merge(bbdd, bbdd_padres, by="idalumno", all=F, suffixes = c("",".y"))
bbdd$resp_pap[is.na(bbdd$resp_al) & bbdd$resp_pap == 1] <- 0
bbdd <- bbdd[!bbdd$resp_pap == "0", ] 
```

## Interés Político

**Pregunta**: Cuánto te interesas por temas políticas y sociales

Categorías de respuesta: 

1. Nada
2. Poco
3. Bastante
4. Mucho


